name: Build and deploy a container to Azure with Managed Identity

env:
  AZURE_WEBAPP_NAME: clustering microservice  # set this to the name of your Azure Web App
  ACR_NAME: clusteringservicecontainerregistry  # ACR name

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-24.04

    steps:
      # Step 1: Check out the repository
      - uses: actions/checkout@v2

      # Step 2: Set up Python
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.12'

      # Step 3: Login to Azure
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Step 4: Create Azure Container Registry if it doesn't exist
      - name: Create Azure Container Registry
        run: |
          ACR_EXISTS=$(az acr list --query "length([?name=='${{ env.ACR_NAME }}'])" -o tsv)
          
          if [ "$ACR_EXISTS" -eq "0" ]; then
            echo "Creating Azure Container Registry..."
            az acr create \
              --name ${{ env.ACR_NAME }} \
              --resource-group ${{ secrets.RESOURCE_GROUP }} \
              --sku Basic \
              --admin-enabled true
            
            echo "Waiting for ACR to be fully provisioned..."
            sleep 30
          else
            echo "Azure Container Registry already exists"
            # Find the resource group for the existing ACR
            ACR_RESOURCE_GROUP=$(az acr list --query "[?name=='${{ env.ACR_NAME }}'].resourceGroup" -o tsv)
            echo "ACR_RESOURCE_GROUP=$ACR_RESOURCE_GROUP" >> $GITHUB_ENV
          fi

      # Step 5: Create Managed Identity (if it doesn't exist)
      - name: Create Managed Identity
        run: |
          # Check if identity exists
          IDENTITY_EXISTS=$(az identity list --resource-group ${{ secrets.RESOURCE_GROUP }} --query "length([?name=='clustering-service-identity'])" -o tsv)
          
          if [ "$IDENTITY_EXISTS" -eq "0" ]; then
            echo "Creating managed identity..."
            az identity create --name clustering-service-identity --resource-group ${{ secrets.RESOURCE_GROUP }}
          else
            echo "Managed identity already exists"
          fi
          
          # Get the identity resource ID
          IDENTITY_ID=$(az identity show --name clustering-service-identity --resource-group ${{ secrets.RESOURCE_GROUP }} --query id -o tsv)
          echo "IDENTITY_ID=$IDENTITY_ID" >> $GITHUB_ENV
          
          # Get the identity principal ID
          PRINCIPAL_ID=$(az identity show --name clustering-service-identity --resource-group ${{ secrets.RESOURCE_GROUP }} --query principalId -o tsv)
          echo "PRINCIPAL_ID=$PRINCIPAL_ID" >> $GITHUB_ENV

      # Step 6: Grant ACR Pull permission to the Managed Identity
      - name: Grant ACR permissions
        run: |
          # Determine which resource group contains the ACR
          if [ -n "${{ env.ACR_RESOURCE_GROUP }}" ]; then
            RESOURCE_GROUP_FOR_ACR="${{ env.ACR_RESOURCE_GROUP }}"
          else
            RESOURCE_GROUP_FOR_ACR="${{ secrets.RESOURCE_GROUP }}"
          fi
          
          echo "Using resource group: $RESOURCE_GROUP_FOR_ACR for ACR operations"
          
          # Get ACR resource ID
          ACR_ID=$(az acr show --name ${{ env.ACR_NAME }} --resource-group $RESOURCE_GROUP_FOR_ACR --query id -o tsv)
          
          # Check if the AcrPull role is already assigned
          ROLE_EXISTS=$(az role assignment list --assignee ${{ env.PRINCIPAL_ID }} --scope $ACR_ID --query "length([?roleDefinitionName=='AcrPull'])" -o tsv)

      # Step 7: Build the Docker image
      - name: Build the Docker image
        run: docker build . --file Dockerfile --tag my-image-name:latest

      # Step 8: Push to Azure Container Registry
      - name: Push to Azure Container Registry
        run: |
          # Determine which resource group contains the ACR
          if [ -n "${{ env.ACR_RESOURCE_GROUP }}" ]; then
            RESOURCE_GROUP_FOR_ACR="${{ env.ACR_RESOURCE_GROUP }}"
          else
            RESOURCE_GROUP_FOR_ACR="${{ secrets.RESOURCE_GROUP }}"
          fi
          
          # Get ACR credentials
          ACR_USERNAME=$(az acr credential show --name ${{ env.ACR_NAME }} --resource-group $RESOURCE_GROUP_FOR_ACR --query username -o tsv)
          ACR_PASSWORD=$(az acr credential show --name ${{ env.ACR_NAME }} --resource-group $RESOURCE_GROUP_FOR_ACR --query "passwords[0].value" -o tsv)
          
          # Login to ACR
          echo "$ACR_PASSWORD" | docker login ${{ env.ACR_NAME }}.azurecr.io --username $ACR_USERNAME --password-stdin
          
          # Tag and push the image
          docker tag my-image-name:latest ${{ env.ACR_NAME }}.azurecr.io/my-image-name:latest
          docker push ${{ env.ACR_NAME }}.azurecr.io/my-image-name:latest

      # Step 9: Deploy to Azure Container Instance with Managed Identity
      - name: Deploy to Azure Container Instance
        run: |
          # Delete existing container instance if it exists
          az container delete \
            --resource-group ${{ secrets.RESOURCE_GROUP }} \
            --name clustering-service \
            --yes || true
          
          # Create container instance with managed identity
          az container create \
            --resource-group ${{ secrets.RESOURCE_GROUP }} \
            --name clustering-service \
            --image ${{ env.ACR_NAME }}.azurecr.io/my-image-name:latest \
            --cpu 1 \
            --memory 1.5 \
            --dns-name-label clustering-service-label \
            --ports 80 \
            --assign-identity /subscriptions/92c72dac-de15-4fff-8935-f7c2a2b6c16b/resourceGroups/clustering_service/providers/Microsoft.ManagedIdentity/userAssignedIdentities/clustering-service-identity \
            --registry-login-server ${{ env.ACR_NAME }}.azurecr.io \
            --identity /subscriptions/92c72dac-de15-4fff-8935-f7c2a2b6c16b/resourceGroups/clustering_service/providers/Microsoft.ManagedIdentity/userAssignedIdentities/clustering-service-identity \
            --os-type Linux \
            --location 'ukwest'
